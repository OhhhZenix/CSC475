start App(mealLogDao, exerciseLogDao, foodCatalogDao, exerciseCatalogDao)
    Declarations
        navController = initialize navigation controller
        selectedMealLog = initialize mutable state with value 0
        selectedExerciseLog = initialize mutable state with value 0
        selectedFoodCatalog = initialize mutable state with value 0
        selectedExerciseCatalog = initialize mutable state with value 0

    start NavHost
        set navigation controller to navController
        set start destination to "Home"

        // Home Screen
        if current destination is "Home" then
            HomeScreen(navController)
        endIf

        // Calculate Goal Screen
        if current destination is "CalculateGoal" then
            CalculateGoalScreen(navController)
        endIf

        // Meal Log Screens
        if current destination is "MealLog" then
            MealLogScreen(navController, mealLogDao, foodCatalogDao, selectedMealLog)
        endIf

        if current destination is "AddMealLog" then
            AddMealLogScreen(navController, mealLogDao, foodCatalogDao)
        endIf

        if current destination is "EditMealLog" then
            EditMealLogScreen(navController, mealLogDao, foodCatalogDao, selectedMealLog)
        endIf

        // Exercise Log Screens
        if current destination is "ExerciseLog" then
            ExerciseLogScreen(navController, exerciseLogDao, exerciseCatalogDao, selectedExerciseLog)
        endIf

        if current destination is "AddExerciseLog" then
            AddExerciseLogScreen(navController, exerciseLogDao, exerciseCatalogDao)
        endIf

        if current destination is "EditExerciseLog" then
            EditExerciseLogScreen(navController, exerciseLogDao, exerciseCatalogDao, selectedExerciseLog)
        endIf

        // Food Catalog Screens
        if current destination is "FoodCatalog" then
            FoodCatalogScreen(navController, foodCatalogDao, selectedFoodCatalog)
        endIf

        if current destination is "AddFood" then
            AddFoodCatalogScreen(navController, foodCatalogDao)
        endIf

        if current destination is "EditFood" then
            EditFoodCatalogScreen(navController, foodCatalogDao, selectedFoodCatalog)
        endIf

        // Exercise Catalog Screens
        if current destination is "ExerciseCatalog" then
            ExerciseCatalogScreen(navController, exerciseCatalogDao, selectedExerciseCatalog)
        endIf

        if current destination is "AddExercise" then
            AddExerciseCatalogScreen(navController, exerciseCatalogDao)
        endIf

        if current destination is "EditExercise" then
            EditExerciseCatalogScreen(navController, exerciseCatalogDao, selectedExerciseCatalog)
        endIf
    end NavHost
end App

start HomeScreen(navController)
    start Scaffold
        set top bar with title "Fitness Tracker"

        start Column
            set fill max size
            set padding to innerPadding

            addSpacer(8)

            start Text
                set content to "Options"
                set padding to 8 (start)
                set font size to 32
            end Text

            addSpacer(2)

            start Text
                set content to "Get your fitness journey started!"
                set padding to 8 (start)
                set font style to italic
            end Text

            addSpacer(4)

            start Button
                set on click to navigate to "CalculateGoal"
                set fill max width
                set padding to 8 (start, end)

                start Text
                    set content to "Calculate Goals"
                end Text
            end Button

            start Button
                set on click to navigate to "MealLog"
                set fill max width
                set padding to 8 (start, end)

                start Text
                    set content to "Meal Log"
                end Text
            end Button

            start Button
                set on click to navigate to "ExerciseLog"
                set fill max width
                set padding to 8 (start, end)

                start Text
                    set content to "Exercise Log"
                end Text
            end Button

            start Button
                set on click to navigate to "FoodCatalog"
                set fill max width
                set padding to 8 (start, end)

                start Text
                    set content to "Food Catalog"
                end Text
            end Button

            start Button
                set on click to navigate to "ExerciseCatalog"
                set fill max width
                set padding to 8 (start, end)

                start Text
                    set content to "Exercise Catalog"
                end Text
            end Button
        end Column
    end Scaffold
end HomeScreen

start CalculateGoalScreen(navController)
    Declarations
        context = get current context
        age = initialize mutable state with empty string
        height = initialize mutable state with empty string
        weight = initialize mutable state with empty string
        sexOptions = initialize mutable list with ["Male", "Female"]
        selectedSex = initialize mutable state with empty string
        isExpanded = initialize mutable state with false
        calculated = initialize mutable state with false
        bmr = initialize mutable state with 0.0
        decimalFormatter = initialize decimal formatter with pattern "#,###.#"

    start Scaffold
        set top bar with title "Calculate Goals"

        start Column
            set padding to innerPadding

            if calculated is true then
                start Column
                    set padding to 8 (start, end), 4 (top, bottom)

                    start Text
                        set content to "Given the following details:"
                    end Text

                    start Text
                        set content to "- Sex: [selectedSex]"
                    end Text

                    start Text
                        set content to "- Age: [formatted age] years old"
                    end Text

                    start Text
                        set content to "- Height: [formatted height] cm"
                    end Text

                    start Text
                        set content to "- Weight: [formatted weight] kg"
                    end Text

                    start Text
                        set content to "Here are the options:"
                    end Text

                    start Text
                        set content to "- Maintain Weight: [formatted bmr] Calories"
                    end Text

                    start Text
                        set content to "- Gain Weight: [formatted bmr + 500] Calories"
                    end Text

                    start Text
                        set content to "- Lose Weight: [formatted bmr - 500] Calories"
                    end Text
                end Column

                start Button
                    set on click to set calculated to false
                    set fill max width
                    set padding to 8 (start, end)

                    start Text
                        set content to "Recalculate"
                    end Text
                end Button

                start Button
                    set on click to navigate to "Home"
                    set fill max width
                    set padding to 8 (start, end)

                    start Text
                        set content to "Back to Home"
                    end Text
                end Button
            else
                addSpacer(4)

                start ExposedDropdownMenuBox
                    set expanded to isExpanded
                    set on expanded change to toggle isExpanded
                    set fill max width
                    set padding to 8 (start, end)

                    start OutlinedTextField
                        set value to selectedSex
                        set on value change to do nothing
                        set label to "Sex"
                        set read only to true
                        set trailing icon to dropdown icon
                        set fill max width
                        set menu anchor type to primary editable
                    end OutlinedTextField

                    start ExposedDropdownMenu
                        set expanded to isExpanded
                        set on dismiss request to set isExpanded to false

                        for each option in sexOptions
                            start DropdownMenuItem
                                set text to option
                                set on click to
                                    set selectedSex to option
                                    set isExpanded to false
                            end DropdownMenuItem
                        endFor
                    end ExposedDropdownMenu
                end ExposedDropdownMenuBox

                start OutlinedTextField
                    set value to age
                    set on value change to
                        if input is a valid double then
                            set age to input
                    set label to "Age (years)"
                    set fill max width
                    set padding to 8 (start, end)
                    set keyboard type to number
                end OutlinedTextField

                start OutlinedTextField
                    set value to height
                    set on value change to
                        if input is a valid double then
                            set height to input
                    set label to "Height (cm)"
                    set fill max width
                    set padding to 8 (start, end)
                    set keyboard type to number
                end OutlinedTextField

                start OutlinedTextField
                    set value to weight
                    set on value change to
                        if input is a valid double then
                            set weight to input
                    set label to "Weight (kg)"
                    set fill max width
                    set padding to 8 (start, end)
                    set keyboard type to number
                end OutlinedTextField

                addSpacer(4)

                start Button
                    set on click to
                        if selectedSex is empty then
                            show toast "A sex has not been selected. Try again."
                        else if age is empty then
                            show toast "Age is empty. Try again."
                        else if age is less than or equal to 0 then
                            show toast "Age must be greater than zero. Try again."
                        else if height is empty then
                            show toast "Height is empty. Try again."
                        else if height is less than or equal to 0 then
                            show toast "Height must be greater than zero. Try again."
                        else if weight is empty then
                            show toast "Weight is empty. Try again."
                        else if weight is less than or equal to 0 then
                            show toast "Weight must be greater than zero. Try again."
                        else
                            if selectedSex is "Male" then
                                set bmr to calculateMaleBMR(weight, height, age)
                            else if selectedSex is "Female" then
                                set bmr to calculateFemaleBMR(weight, height, age)
                            set calculated to true
                    set fill max width
                    set padding to 8 (start, end)

                    start Text
                        set content to "Calculate"
                    end Text
                end Button

                start Button
                    set on click to navigate to "Home"
                    set fill max width
                    set padding to 8 (start, end)

                    start Text
                        set content to "Back"
                    end Text
                end Button
            endIf
        end Column
    end Scaffold
end CalculateGoalScreen

start MealLogScreen(navController, mealLogDao, foodCatalogDao, selectedMealLog)
    Declarations
        coroutineScope = initialize coroutine scope
        meals = initialize mutable state list of pairs (MealLog, FoodCatalog?)
        totalCalories = initialize mutable state with 0.0
        decimalFormatter = initialize decimal formatter with pattern "#,###.#"

    start LaunchedEffect
        launch coroutine
            for each log in mealLogDao.getTodayLogs()
                food = foodCatalogDao.getFood(log.foodId)
                add (log, food) to meals
                add (food.calories * log.quantity) to totalCalories
            endFor
        endLaunch
    end LaunchedEffect

    start Scaffold
        set top bar with title "Meal Log"

        start Column
            set padding to innerPadding

            start Button
                set on click to navigate to "Home"
                set padding to 8

                start Text
                    set content to "Back"
                end Text
            end Button

            start Text
                set content to "Today's Intake"
                set fill max width
                set text align to center
                set font size to 32
            end Text

            start Text
                set content to "Total Calories: [formatted totalCalories]"
                set fill max width
                set text align to center
                set font style to italic
            end Text

            start Button
                set on click to navigate to "AddMealLog"
                set fill max width
                set padding to 8

                start Text
                    set content to "Add meal"
                end Text
            end Button

            if meals is empty then
                start Box
                    set fill max size
                    set content alignment to center

                    start Column
                        set horizontal alignment to center
                        set vertical arrangement to center

                        start Text
                            set content to "No logs available from today."
                            set text align to center
                        end Text

                        start Text
                            set content to "Get started by adding one."
                            set text align to center
                        end Text
                    end Column
                end Box
            else
                start Text
                    set content to "Meals from Today:"
                    set padding to 8 (start)
                end Text

                start LazyColumn
                    for each meal in meals (sorted by dateTime, reversed)
                        if meal.second is not null then
                            start Button
                                set on click to
                                    set selectedMealLog to meal.first.id
                                    navigate to "EditMealLog"
                                set fill max width
                                set padding to 8 (start, end, bottom)
                                set shape to rounded corners (8)

                                start Row
                                    set horizontal arrangement to space between
                                    set vertical alignment to center

                                    start Column
                                        start Text
                                            set content to meal.second.name
                                            set font weight to bold
                                            set font size to 16
                                        end Text

                                        start Text
                                            set content to "Quantity: [formatted meal.first.quantity]"
                                            set font weight to light
                                        end Text

                                        start Text
                                            set content to "Total Calories: [formatted meal.second.calories * meal.first.quantity]"
                                            set font weight to light
                                        end Text
                                    end Column

                                    start Text
                                        set content to formatted meal.first.dateTime (pattern: "MMM dd yyyy hh:mm a")
                                        set text align to end
                                        set fill max width
                                    end Text
                                end Row
                            end Button
                        endIf
                    endFor
                end LazyColumn
            endIf
        end Column
    end Scaffold
end MealLogScreen